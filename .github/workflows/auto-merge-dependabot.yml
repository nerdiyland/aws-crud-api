name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Check if PR is for CDK updates
        id: check-cdk
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Check if this is a CDK-related update
          if [[ "$PR_TITLE" == *"aws-cdk-lib"* || "$PR_TITLE" == *"constructs"* ]]; then
            echo "is_cdk_update=true" >> $GITHUB_OUTPUT
            echo "CDK update detected"
          else
            echo "is_cdk_update=false" >> $GITHUB_OUTPUT
            echo "Not a CDK update"
          fi

      - name: Wait for CI to complete
        if: steps.check-cdk.outputs.is_cdk_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            
            console.log(`Waiting for CI to complete for PR #${pr_number}`);
            
            // Wait for all checks to complete
            let allChecksPassed = false;
            let attempts = 0;
            const maxAttempts = 30; // Wait up to 15 minutes
            
            while (!allChecksPassed && attempts < maxAttempts) {
              attempts++;
              console.log(`Attempt ${attempts}/${maxAttempts}`);
              
              // Get the latest commit SHA
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr_number
              });
              
              const sha = pr.head.sha;
              console.log(`Checking status for commit ${sha}`);
              
              // Get check runs for this commit
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: sha
              });
              
              // Get status checks for this commit  
              const { data: statusChecks } = await github.rest.repos.getCombinedStatusForRef({
                owner,
                repo,
                ref: sha
              });
              
              console.log(`Found ${checkRuns.check_runs.length} check runs`);
              console.log(`Status state: ${statusChecks.state}`);
              
              // Check if all checks are completed and successful
              const allChecksCompleted = checkRuns.check_runs.every(check => 
                check.status === 'completed'
              );
              
              const allChecksSuccessful = checkRuns.check_runs.every(check => 
                check.conclusion === 'success' || check.conclusion === 'neutral'
              );
              
              const statusSuccessful = statusChecks.state === 'success' || statusChecks.statuses.length === 0;
              
              if (allChecksCompleted && allChecksSuccessful && statusSuccessful) {
                allChecksPassed = true;
                console.log('âœ… All checks passed!');
              } else {
                console.log('â³ Waiting for checks to complete...');
                console.log(`Checks completed: ${allChecksCompleted}`);
                console.log(`Checks successful: ${allChecksSuccessful}`);
                console.log(`Status successful: ${statusSuccessful}`);
                
                // Wait 30 seconds before checking again
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
            }
            
            if (!allChecksPassed) {
              throw new Error('Timed out waiting for CI checks to pass');
            }

      - name: Enable auto-merge
        if: steps.check-cdk.outputs.is_cdk_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            
            console.log(`Enabling auto-merge for PR #${pr_number}`);
            
            try {
              await github.rest.pulls.enableAutoMerge({
                owner,
                repo,
                pull_number: pr_number,
                merge_method: 'merge'
              });
              
              console.log('âœ… Auto-merge enabled');
              
              // Add a comment to the PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr_number,
                body: 'ðŸ¤– **Auto-merge enabled** for this CDK dependency update.\n\nThis PR will be automatically merged once all checks pass. The automated publishing workflow will then sync the package version with the CDK version and publish to npm.'
              });
              
            } catch (error) {
              console.error('Failed to enable auto-merge:', error);
              
              // Try manual merge as fallback
              console.log('Attempting manual merge...');
              
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr_number,
                merge_method: 'merge',
                commit_title: 'chore(deps): auto-merge CDK dependency update',
                commit_message: 'Automatically merged CDK dependency update via GitHub Actions'
              });
              
              console.log('âœ… Manual merge completed');
            }

      - name: Skip non-CDK updates
        if: steps.check-cdk.outputs.is_cdk_update == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            console.log(`PR #${pr_number} is not a CDK update, skipping auto-merge`);
            
            // Add a comment explaining why auto-merge was skipped
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: 'ðŸ“‹ **Manual review required** for this dependency update.\n\nThis PR contains non-CDK dependency updates that require manual review before merging.'
            });
